# CODEV План: Telegram Reader 2.0 (модерация, дайджесты, аналитика)

> Протокол: SPIDER-SOLO  
> Связанная спецификация: `codev/specs/0006-telegram-automation-innovation.md` (TBD)  
> Контекст: Telethon скрипты (`read.py`, `tg.py`, `autoanswer.py`), OpenAI автоответчик, N8N мониторинг/бэкапы, чат-аналитика.

## Цели
- Выпустить модератор/Trust & Safety слой для чатов и экспортов.
- Автоматизировать дайджесты и архив лучших сообщений с реакциями.
- Дать real-time метрики вовлечённости и кампаний с алертами.
- Обогатить автоответчик RAG-поиском по медиа и роутингом LLM.
- Укрепить SRE-контур: N8N guard, безопасные бэкапы, тестовый мок Telethon.

## Фазы

### Фаза 0: Контур и данные (Status: pending)
**Objective**: Зафиксировать контракты данных, окружения и логирования.  
**Tasks**:
- [ ] Провести inventory env/ключей (.env, sessions), зафиксировать env contract (обновить `ENV_SETUP.md` при необходимости).
- [ ] Определить схемы событий/логов (message, reaction, moderation, autoanswer) и границы PII.
- [ ] Настроить общие utility-модули: rate limits, retries, структурированное логирование.
- [ ] Подготовить фикстуры чатов/сообщений для последующих фаз (text + media).
**Success Metrics**:
- Контракт окружения и схемы событий задокументированы.
- Фикстуры готовы и переиспользуются в тестах/моках.

### Фаза 1: Trust & Safety + авто-модератор (Status: pending)
**Dependencies**: Phase 0  
**Objective**: Блокировать спам/PII и выдавать безопасные экспорты.  
**Tasks**:
- [ ] Реализовать pipeline модерации: детекция спама/пэйволлов/линков, эвристики + LLM fallback.
- [ ] Добавить redaction/анонимизацию в экспорт (`read.py`/`tg.py`) и в live-мониторинг.
- [ ] Встроить action-политику: мут/удаление/эскалация с configurable thresholds.
- [ ] Покрыть тестами: ложноположительные/ложноотрицательные, отсутствие сбоев на медиа.
- [ ] Логирование инцидентов в отдельный канал/файл.
**Success Metrics**:
- ≥90% спама в тестовом датасете отфильтровано, <5% ложных срабатываний.
- 0 PII в примерах экспортов.
- Модератор не ломает автоответчик/экспорт (smoke тесты проходят).

### Фаза 2: Дайджесты и Архивариус (Status: pending)
**Dependencies**: Phase 0  
**Objective**: Генерировать сюжетные дайджесты и курировать топ-посты.  
**Tasks**:
- [ ] Скоупинг правил отбора (реакции, авторы, темы), ранжирование и фильтр дублей.
- [ ] Генерация narrative дайджестов (LLM) с цитатами/реакциями, экспорт в Markdown + канал.
- [ ] «Архивариус»: автопубликация best-of постов в отдельный чат/канал + сохранение медиа.
- [ ] Планировщик (cron/async task) и CLI для ручного запуска/превью.
- [ ] Тесты на сбор/ранжирование, snapshot тесты для дайджестов.
**Success Metrics**:
- Дайджест за день строится <2 мин, полнота ≥90% топ-постов.
- Канал best-of обновляется без дубликатов, медиа ссылки валидны.

### Фаза 3: Pulse аналитика и кампании (Status: pending)
**Dependencies**: Phase 0  
**Objective**: Real-time картина вовлечённости и связка пост→кампания.  
**Tasks**:
- [ ] Сбор реакций/ER в потоковом режиме; хранение агрегатов (минутные/часовые).
- [ ] Heatmap/панель: API/CLI, визуализация (md/PNG) по авторам/темам.
- [ ] Алерты о падении ER/CTR/ответов, настройка порогов в `.env`/config.
- [ ] Кампании: тэгирование постов (campaign_id), связка с CRM/Sheets экспортом.
- [ ] Тесты: генерация синтетических реакций, проверки задержек/агрегатов.
**Success Metrics**:
- Freshness данных ≤60 сек, ошибки агрегации = 0 в тестах.
- Алерт срабатывает в тестовом сценарии <90 сек после деградации.
- Экспорт кампаний корректно мапится на CRM/Sheets sample.

### Фаза 4: RAG по медиа + Multi-LLM router (Status: pending)
**Dependencies**: Phase 0  
**Objective**: Доступ к контенту (текст/ASR/CV) и оптимизация затрат LLM.  
**Tasks**:
- [ ] Ингест медиа: ASR для аудио/видео, CV-тэги для изображений; хранение эмбеддингов локально.
- [ ] Query API для автоответчика и операторов: поиск по тексту/объектам/речи.
- [ ] Роутер моделей: fast/cheap vs smart, правила по длине/риску/конфиденциальности.
- [ ] Кеширование ответов и reuse эмбеддингов между чатами (privacy-aware).
- [ ] Тесты: регрессия поиска на фикстурах, сравнение стоимости до/после роутинга.
**Success Metrics**:
- P95 поиска <1.5 сек на локальном индексе.
- Снижение затрат на LLM ≥30% при одинаковой точности (на тестовых сценариях).
- Роутер не уводит чувствительные запросы на внешние модели (политики соблюдены).

### Фаза 5: Ops Guard и непрерывность (Status: pending)
**Dependencies**: Phase 0  
**Objective**: Устойчивые бэкапы, тесты и контроль N8N/ботов.  
**Tasks**:
- [ ] «Сторож» N8N: мониторинг метрик, автоперезапуск, чат-уведомления, change-log.
- [ ] Quiet autoanswer: черновики ответов с подтверждением оператора; лог принят/отклонён.
- [ ] GitHub Actions plugin: мок Telethon, симулятор трафика, проверки rate limits.
- [ ] Backup++: дедупликация медиа, диффы, restore в песочницу.
- [ ] Smoke/health чеклисты и e2e тест, кроны для регулярных прогонов.
**Success Metrics**:
- N8N недоступность обнаруживается <60 сек, авто-restore успешен в тесте.
- Quiet-режим: ≥95% черновиков без падений, лог корректен.
- CI прогоняет мок-тесты <10 мин, бэкапы проходят проверку restore.

## Артефакты и контроль
- План: `codev/plans/0004-telegram-automation-innovation.md` (текущий документ).
- Спека: `codev/specs/0006-telegram-automation-innovation.md` (создать).
- Ревью: `codev/reviews/0004-telegram-automation-innovation.md` (после пилота).
- Чек-листы: smoke для автоответчика/модератора, восстановление из бэкапа, прогон CI моков.
