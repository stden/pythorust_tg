# CODEV План: Надёжность Telegram Reader/Auto-responder

> Протокол: SPIDER-SOLO  
> Связанная спецификация: `codev/specs/0001-telegram-automation-quality.md` (TBD)  
> Контекст: Rust утилиты `telegram_reader` (экспорт, автоответчик, Linear CLI), Playwright тест `example-site`

## Цели
- Повысить надёжность экспорта/автоответчика и покрыть ключевые ветки тестами
- Ужесточить работу с сессиями и конфигом, исключить гонки и утечки
- Улучшить наблюдаемость и UX CLI-команд

## Итерация 2025-11-24 (безопасность)
- Конфиг `config.yml` приведён к обезличенному виду (только placeholders + env), убраны реальные `api_id/api_hash/phone/user` и чаты.
- OpenAI ключ теперь берётся только из окружения в `autoanswer.py` (исключено чтение ключа из yaml).
- Сообщение об отсутствии сессии больше не выводит номер телефона (`telegram_session.py`), снижая риск утечки.
- Follow-ups: ревизия файлов с чат-логами/переписками (например, `vibecod3rs.md`) и при необходимости перенос в приватное хранилище; ротация ключей, если старые значения могли утечь.
- Тесты не прогонялись в этой итерации.

## Фазы

**Фаза 1: Базовая защита и тесты**
- Объектив: Закрыть пробелы в юнит-тестах и стабилизировать существующие (Rust, Playwright).
- Задачи:
  - Дополнить unit-тесты `reactions`, `export`, `linear` (edge-кейсы на пустые значения, тримминг, ошибки HTTP/JSON).
  - Поднять и прогнать Playwright `tests/playwright/tests/example-site.spec.ts`, зафиксить падения.
  - Включить `cargo test` в CI (или локальный чек-лист) как обязательный шаг перед пушем.
- Доставляемое: зелёные `cargo test` и актуальные UI-тесты.
- Проверка/критерии готовности: `cargo test`; `npx playwright test tests/playwright/tests/example-site.spec.ts`; баги Playwright закрыты или задокументированы.
- Риски/mitigation: Флапающие UI-тесты → зафиксировать локаторы/тайминги, разрешить `--headed`/tracing для отладки.

**Фаза 2: Сессии и конфигурация**
- Объектив: Исключить конфликт доступа к Telegram-сессии и ошибок конфигурации.
- Задачи:
  - Валидация env/кредов на старте CLI/бинарей; дружелюбные ошибки.
  - Убедиться, что `SessionLock` удаляет lock-файл при панике/Drop; добавить тест на двойное захватывание.
  - Документировать шаги `init_session` (README или отдельный HOWTO).
- Доставляемое: обновлённый init/lock-модуль и краткий how-to.
- Проверка/критерии готовности: юнит-тесты на блокировку/очистку; ручная проверка `cargo run --bin init_session`; lock-файл удаляется после принудительного drop.
- Риски/mitigation: Неконсистентный lock при панике → тест со стейджированным panic + чистка; несовместимость путей на Windows → учесть в путях lock-файла.

**Фаза 3: Экспорт и медиа**
- Объектив: Гарантировать корректные метаданные и файловую структуру при выгрузке.
- Задачи:
  - Нормализовать формат строк (таймстемпы, эмодзи), тримминг пробелов.
  - Создавать каталоги для медиа перед записью; покрыть тестом.
  - Обработать отсутствие sender/peer (fallback имён).
  - Добавить интеграционный сценарий с фиктивными сообщениями (markdown + медиа пути).
- Доставляемое: стабильный экспорт (Markdown + медиа каталоги).
- Проверка/критерии готовности: юнит/интегра-тесты на `ExportWriter`, проверка реального markdown вывода; медиа каталоги создаются/очищаются корректно.
- Риски/mitigation: Изменения формата нарушат совместимость с Python-скриптами → зафиксировать формат в README; потенциальные гонки записи медиа → опциональный файл-lock или порядковая запись.

**Фаза 4: Автоответчик и наблюдаемость**
- Объектив: Повысить устойчивость автоответчика и прозрачность работы.
- Задачи:
  - Структурированное логирование (tracing) для ключевых событий.
  - Тайм-ауты/ретраи на OpenAI запросы, классификация ошибок (сетевые/лимиты).
  - Метрики успешных ответов и падений сессии; защитить сессию от креша при 429/5xx.
- Доставляемое: автоответчик, который восстанавливается после API ошибок и пишет понятные логи.
- Проверка/критерии готовности: юнит-тесты на обработку ошибок; локальный прогон с фиктивным OpenAI ответом + эмуляция 429/5xx; логи содержат correlation-id и статусы.
- Риски/mitigation: rate-limit OpenAI → backoff + jitter; утечка сессии при панике → guard-врапперы вокруг сетевых вызовов.

**Фаза 5: CLI/Linear UX**
- Объектив: Сделать CLI-команды предсказуемыми и минимизировать ошибочные вызовы.
- Задачи:
  - Валидация аргументов `linear` (ключи/команда/поля) + дружественные подсказки для пустых заголовков/команд.
  - Кеширование team-id и строгий контроль ошибок HTTP/JSON; тесты на обрезку пробелов.
  - Обновить CLI help/README под новые проверки.
- Доставляемое: обновлённый CLI с чёткими сообщениями.
- Проверка/критерии готовности: `cargo test -p telegram_reader linear::tests`; ручные проверки `cargo run --bin linear ...` с тестовым сервером; help отражает новые валидации.
- Риски/mitigation: Сломать существующие скрипты → сохранить совместимые флаги/алиасы, добавить предупреждения вместо жёстких ошибок там, где возможно.

## Открытые вопросы
- Нужен ли единый `.env` для Rust/Playwright или раздельный?
- Требуется ли скачивание медиа в CI или достаточно пропуска (как в Python-скриптах)?
- Нужны ли интеграционные тесты против «песочницы» Telegram или только моками?

## Артефакты и контроль
- План: `codev/plans/0001-telegram-automation-quality.md` (текущий документ).
- Спека: `codev/specs/0001-telegram-automation-quality.md` (создать после уточнения открытых вопросов).
- Ревью: `codev/reviews/0001-telegram-automation-quality.md` (заполнить после завершения работ).
- Чек-листы прогона: `cargo test`, `npx playwright test tests/playwright/tests/example-site.spec.ts`, ручной запуск `cargo run --bin init_session` и `cargo run --bin linear ...`.
