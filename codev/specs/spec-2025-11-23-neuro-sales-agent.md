# Specification: Нейропродажник (чат/голос) для Telegram

## Metadata
- **ID**: spec-2025-11-23-neuro-sales-agent
- **Status**: draft
- **Created**: 2025-11-23

## Clarifying Questions Asked
- Запрос пользователя: ТЗ на «нейропродажник» после обсуждения характеристик продаваемого ассистента. Доп. вопросы не задавались; работа по зафиксированным предположениям ниже.

## Problem Statement
Продажи в Telegram и через звонки зависят от ручных операторов: ответы медленные, нет единых скриптов, нет автоматического отбора лидов, часто теряются контакты и история, нет связки с остатками и ценами. Нужен AI-ассистент-продавец, который быстро отвечает, ведёт диалог по скриптам, учитывает ассортимент и остатки, фиксирует лиды в CRM/таблице и эскалирует сложные кейсы человеку.

## Current State
- Есть базовый автответчик (`autoanswer.py`) без жёстких продажных скриптов, без подключения каталога/остатков и без логирования лидов.
- Чаты читаются через Telethon (`read.py`, `tg.py`), но нет автоматических триггеров продаж и CTA.
- Нет голосового канала; нет SIP-интеграции и нет TTS/STT пайплайна в проде (только заготовки в `integrations/`).
- Каталог/цены/остатки хранятся вручную (лист, сообщения), нет единого источника.

## Desired State
- AI-продавец в Telegram (text-first), опционально голос через SIP/VoIP: отвечает за ≤3с p95, ведёт диалог по скриптам, сам инициирует предложения по триггерам (новый подписчик, запрос цены, просмотр каталога).
- Знает ассортимент, цены, остатки, акции; даёт апсейл/даунсейл/комплекты; не выдумывает, при неизвестных данных пишет «уточняю».
- Фиксирует лиды/сделки в CRM/Google Sheet (имя, контакт, запрос, статус, сумма, ссылка на чат/звонок).
- Логи диалогов и метрики (конверсии, скорость ответа, отказы, эскалации) сохраняются.
- Чёткая эскалация человеку: по стоп-словам, по отсутствию каталога, по просрочке ответа >N секунд.
- Профили/тональность настраиваются per-чат (system prompt + параметры агрессии/срочности).
- Голосовой канал (MVP): входящие/исходящие звонки через SIP, связка STT→LLM→TTS, latency до ответа ≤1.5 с p95.

## Stakeholders
- **Primary Users**: Операторы/владельцы чатов, которым нужен автопродажник; конечные покупатели в Telegram.
- **Secondary Users**: Руководители продаж, маркетинг (получают метрики/лиды).
- **Technical Team**: Разработчик/DevOps проекта (репо `my_telegram`).
- **Business Owners**: Заказчик ассистента (команда проекта).

## Success Criteria
- [ ] p95 время первого ответа в чате ≤3с; в голосе round-trip ≤1.5с.
- [ ] ≥90% ответов содержат CTA (оплата/доставка/контакт) или следующий шаг.
- [ ] 0 галлюцинаций по цене/наличию (верификация через источник каталога); при неизвестных данных — «уточняю».
- [ ] Лиды пишутся в CRM/Sheet со статусом и ссылкой на диалог; не менее 95% диалогов с покупательским намерением зафиксированы.
- [ ] Эскалация человеку срабатывает по правилам и фиксируется в логе.
- [ ] Логи/метрики доступны (скорость ответа, конверсии, эскалации, отказы).
- [ ] All tests pass with >90% coverage (юнит/интеграция для логики бота).
- [ ] Performance benchmarks met (см. Performance Requirements).
- [ ] Documentation updated.

## Constraints
### Technical Constraints
- Стек Python 3 + Telethon; OpenAI/локальные модели через существующие клиенты (`integrations/openai_client.py`, `integrations/ollama_client.py`).
- Источник каталога: CSV/Google Sheet/Notion API; выбираем один как источник правды.
- Безопасное хранение API ключей (.env); без логирования чувствительных данных (карты, адреса).
- Голос: SIP провайдер (Zadarma/Exolve/Twilio) + локальный STT/TTS (Whisper/Silero) для контроля стоимости.

### Business Constraints
- Соответствие ToS Telegram/SIP-провайдеров; без спама.
- Минимизация стоимости: локальный STT/TTS предпочтительнее облачных вызовов.
- Поддержка RU/EN (минимум) в текстовых ответах.

## Assumptions
- Каталог товаров/услуг готов в структурированном виде (Sheet/CSV) и обновляется минимум раз в сутки.
- Есть действующие ключи OpenAI или локальная LLM поднята; ключи SIP доступны для теста.
- Доступ к Google Sheet/CRM предоставлен для записи лидов.
- В чате разрешены боты/автоответчики; есть человек для эскалации.

## Solution Approaches

### Approach 1: Chat-first Telegram Sales Agent (голос как опция)
**Description**: Основной канал — Telegram (чат). Модель генерирует ответы с учётом каталога, реакций и правил. Голос подключается позже как отдельный воркер через SIP.

**Pros**:
- Быстрый запуск, меньше интеграций.
- Можно использовать существующий `autoanswer.py` и Telethon.
- Низкий риск регуляторки (без звонков).

**Cons**:
- Нет охвата голосовых лидов.
- Латентность/качество зависят от внешнего API, если не поднята локальная LLM.

**Estimated Complexity**: Medium  
**Risk Level**: Medium

### Approach 2: Full Duplex Voice + Chat
**Description**: Параллельно чаты и голосовые звонки через SIP + STT/TTS; диалоговая машина общая (state machine).

**Pros**:
- Закрывает входящие/исходящие звонки, максимальный охват.
- Единая логика диалога между каналами.

**Cons**:
- Больше интеграций (SIP, аудио пайплайн, echo cancellation).
- Жёсткие требования к latency и инфраструктуре.

**Estimated Complexity**: High  
**Risk Level**: High

## Open Questions

### Critical (Blocks Progress)
- [ ] Выбор источника каталога/остатков (Sheet vs CSV vs DB) и формат полей.
- [ ] Выбор SIP провайдера и тарифа (для голоса) или исключаем голос из MVP.

### Important (Affects Design)
- [ ] Нужен ли многоязычный профиль (RU/EN/EE/…); как выбирать язык.
- [ ] Политика по upsell/discounts (жёсткие правила vs LLM-решение).
- [ ] Требуемый объём логирования (полные тексты vs метаданные).

### Nice-to-Know (Optimization)
- [ ] Нужны ли A/B тесты скриптов и CTA.
- [ ] Нужен ли антиспам-фильтр для входящих.

## Performance Requirements
- **Chat Response Time**: ≤3с p95 от события до отправки сообщения.
- **Voice Round-trip**: ≤1.5с p95 (SIP → STT → LLM → TTS → RTP).
- **Throughput**: 10 одновременных чат-диалогов на одном экземпляре; 3 одновременных голосовых сессии на GPU 12GB.
- **Resource Usage**: LLM 7-8B 4-bit помещается в 12GB VRAM; CPU 8 vCPU для STT/TTS потоков.
- **Availability**: 99% аптайм сервиса бота; graceful restart без потери диалогового состояния (state в Redis/SQLite).

## Security Considerations
- Хранить API ключи в .env/секретах; ограничить доступ по ACL.
- Не логировать PII (телефоны, адреса) в открытом виде; маскировать при необходимости.
- Ограничить команды бота только выбранными чатами/каналами.
- Защита от prompt injection: чистка пользовательского ввода, system prompt фиксирован.

## Test Scenarios
### Functional Tests
1. Пользователь спрашивает цену/наличие товара из каталога — бот выдаёт цену, наличие, CTA на оплату/доставку.
2. Бот не знает позицию — отвечает «уточняю», ставит флаг эскалации, не выдумывает цену.
3. Триггер брошенной корзины/неотвеченного вопроса — бот повторно предлагает оффер с скидкой/доставкой.
4. Голос: входящий звонок — STT распознаёт фразу, LLM отвечает по скрипту, TTS отдаёт звук ≤1.5с.

### Non-Functional Tests
1. Нагрузочный: 10 параллельных чат-диалогов — p95 ≤3с.
2. Failover: падение LLM — бот уходит в запасной профиль (простые шаблоны) и эскалирует оператору.
3. Безопасность: ввод prompt injection не меняет system prompt; бот не раскрывает ключи/системные инструкции.

## Dependencies
- **External Services**: OpenAI API или локальная LLM (Ollama); SIP провайдер (опц.); Google Sheets/CRM API.
- **Internal Systems**: `autoanswer.py`, `integrations/openai_client.py`, `integrations/ollama_client.py`, `integrations/yandex_tts.py` (для STT/TTS), Telethon сессии.
- **Libraries/Frameworks**: telethon, openai, requests, python-dotenv, whisper/whispercpp или silero, pytest.

## References
- `autoanswer.py`, `read.py`, `telegram_session.py` — текущая логика Telegram.
- `integrations/` — клиенты OpenAI/Ollama/Yandex TTS.
- Проектные заметки: `projects_tasks.md` (блок «Голосовой AI-продавец»), `AGENTS.md` (общее описание).

## Risks and Mitigation
| Risk | Probability | Impact | Mitigation Strategy |
|------|-------------|--------|---------------------|
| Галлюцинации цены/наличия | Medium | High | Чёткая валидация ответов через каталог; при отсутствии данных — эскалация. |
| Высокая задержка (LLM/STT/TTS) | Medium | High | Локальные модели, прогрев, кэширование подсказок, ограничение длины контекста. |
| Блокировка бота/спам | Low | Medium | Ограничить автоответчик чатами, соблюдать ToS, антиспам-триггеры. |
| Качество аудио/распознавания | Medium | Medium | Подбор STT модели под язык, шумоподавление, настройка кодеков SIP. |
| Утечка PII в логах | Medium | High | Маскирование данных, контроль доступа к логам, настройки ретенции. |

## Expert Consultation
Не применимо (SPIDER-SOLO, без внешних агентов).

## Approval
- [ ] Technical Lead Review
- [ ] Product Owner Review
- [ ] Stakeholder Sign-off
- [ ] Expert AI Consultation Complete

## Notes
- Рекомендуем стартовать с Approach 1 (chat-first) и подключать голос отдельной фазой после проверки конверсий.
